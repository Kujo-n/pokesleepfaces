# データ更新ガイド

このプロジェクトでは、ポケモンのデータ（`data/mockData.ts`）をGoogle Sheetsで管理し、スクリプトを使用して自動生成する仕組みを採用しています。

## 1. 概要

- **マスターデータ**: Google Sheets
- **生成されるファイル**: `data/mockData.ts`
- **同期ツール**: `npm run update:data` (`scripts/fetch-sheets-to-ts.js`)

```mermaid
graph LR
    A[Google Sheets] -->|npm run update:data| B[fetch-sheets-to-ts.js]
    B -->|自動生成| C[data/mockData.ts]
    C --> D[Next.js App]
```

## 2. Google Sheetsの構造

スプレッドシートは以下の3つのシートで構成されています。

### シート1: `Pokemon` (基本情報)

| 列名 | 説明 | 例 |
|------|------|-----|
| dexNumber | 図鑑番号 | `1` |
| name | ポケモン名 | `フシギダネ` |
| type | タイプ | `くさ` |
| sleepType | 睡眠タイプ | `うとうと` |
| (フィールド名の列) | 各フィールドへの出現有無 | `TRUE` または `FALSE` |

**フィールド列の形式**:
- `Fields`シートで定義された各フィールド名が列として展開されます
- 出現するフィールドのセルには`TRUE`を入力します
- 出現しないフィールドのセルには`FALSE`を入力します

**例**:

| dexNumber | name | type | sleepType | ワカクサ本島 | シアンの砂浜 | トープ洞窟 | ... |
|-----------|------|------|-----------|--------------|--------------|------------|-----|
| 1 | フシギダネ | くさ | うとうと | TRUE | FALSE | FALSE | ... |

> **注意**: `id`は`p{dexNumber}_{name}`の形式で自動生成されます。

### シート2: `Styles` (寝顔情報)

| 列名 | 説明 | 例 |
|------|------|-----|
| pokemonName | ポケモン名（結合キー） | `フシギダネ` |
| styleName | 寝顔の名前 | `こうごうせい寝` |
| rarity | レアリティ（1-4） | `1` |
| (フィールド名の列) | 各フィールドへの出現有無 | `TRUE` または `FALSE` |

**フィールド列の形式**:
- `Pokemon`シートと同様に、`Fields`シートで定義された各フィールド名が列として展開されます
- 出現するフィールドのセルには`TRUE`を入力します
- 出現しないフィールドのセルには`FALSE`を入力します

**例**:

| pokemonName | styleName | rarity | ワカクサ本島 | シアンの砂浜 | トープ洞窟 | ... |
|-------------|-----------|--------|--------------|--------------|------------|-----|
| フシギダネ | こうごうせい寝 | 1 | TRUE | FALSE | FALSE | ... |

> **注意**: `pokemonName`は`Pokemon`シートの`name`と完全に一致させる必要があります。

> **データ構造の最適化**: 生成される`mockData.ts`では、データサイズ削減のため、寝顔ごとの出現フィールド（`locations`）ではなく、ポケモンの出現フィールドから除外するフィールドリスト（`excludeFromFields`）を保持します。ポケモンの全フィールドに出現する寝顔（大多数）では、このプロパティが省略されます。

### シート3: `Fields` (フィールド定義)

| 列名 | 説明 | 例 |
|------|------|-----|
| name | フィールド名 | `ワカクサ本島` |
| order | 表示順序 | `1` |

## 3. 更新手順

### 基本フロー

1. **Google Sheetsを編集する**
2. **ローカル環境でスクリプトを実行する**
   ```bash
   npm run update:data
   ```
3. **データの整合性を確認する（推奨）**
   Google Sheetsのデータ更新が正しく反映されたか確認するため、以下のコマンドを実行します。
   
   ```bash
   node scripts/verify-all-fields.js
   ```

   **確認ポイント**:
   - 各フィールドの寝顔数が期待通りか確認します。
   - `ワカクサ本島EX` などの特殊フィールドでの数が正しいか特に注意します。
   - 出力結果はマークダウンテーブル形式なので、GitHubのIssueなどにそのまま貼り付け可能です。

4. **変更を確認し、コミットする**
   ```bash
   git add data/mockData.ts
   git commit -m "chore: update pokemon data"
   git push
   ```

### ケース別手順

#### A. 新しいポケモンを追加する場合

1. `Pokemon`シートに行を追加し、基本情報を入力します。
2. 出現するフィールドの列に`TRUE`、出現しないフィールドの列に`FALSE`を入力します。
3. `Styles`シートに行を追加し、そのポケモンの寝顔情報を入力します。
   - `pokemonName`には`Pokemon`シートと同じ名前を入力してください。
   - 出現するフィールドの列に`TRUE`、出現しないフィールドの列に`FALSE`を入力します。
4. `npm run update:data`を実行します。

#### B. 寝顔の名前や出現場所を修正する場合

1. `Styles`シートの該当する行を修正します。
   - 出現場所を変更する場合は、該当するフィールドの列の値を`TRUE`または`FALSE`に変更します。
2. `npm run update:data`を実行します。

#### C. 新しいフィールドを追加する場合

1. `Fields`シートに行を追加し、フィールド名と順序を入力します。
2. `Pokemon`シートと`Styles`シートの右側に、新しいフィールド名の列を追加します。
   - **注意**: 列名は`Fields`シートの`name`と完全に一致させてください。
3. 全てのポケモン/寝顔の行で、新しい列に`TRUE`（出現する）または`FALSE`（出現しない）を入力します。
4. `npm run update:data`を実行します。

## 4. 環境設定

この仕組みを使用するには、以下の設定が必要です。

### .env.local

スプレッドシートIDを設定します。

```env
GOOGLE_SHEETS_ID=your_spreadsheet_id_here
```

### Google Sheetsの公開設定

スクリプトがデータにアクセスできるように、スプレッドシートを以下のいずれかの方法で公開する必要があります：

1. **ウェブに公開（推奨）**
   - 「ファイル」→「共有」→「ウェブに公開」
   - 「ドキュメント全体」を「ウェブページ」として公開

2. **リンク共有**
   - 「共有」→「リンクを知っている全員」に設定

## 5. トラブルシューティング

### Q. `Request failed with status code 403` エラーが出る
**A.** スプレッドシートが公開されていないか、アクセス権限がありません。「ウェブに公開」設定を確認してください。

### Q. `Warning: No styles found for Pokemon "XXX"` と表示される
**A.** `Pokemon`シートに追加したポケモンに対応する寝顔が`Styles`シートに見つかりません。`pokemonName`が正しく入力されているか（スペースの有無など）確認してください。

### Q. データが更新されない
**A.** Google Sheetsの変更が反映されるまで数分かかる場合があります。少し待ってから再度実行してください。また、`npm run update:data`が正常に終了したか（`✅ Successfully generated...`）確認してください。
