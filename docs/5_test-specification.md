# テストケース仕様書

本ドキュメントでは、PokemonCard および useCollection に関するテストケースの目的（WHY）と検証方法（HOW）を記載します。

---

## 1. PokemonCard コンポーネントテスト

### 1.1 基本表示テスト

| テスト名 | WHY（目的） | HOW（検証方法） |
|---------|------------|----------------|
| ポケモン名と図鑑番号の表示 | カードが正しくレンダリングされることを保証 | `screen.getByText` でテキスト要素の存在を確認 |
| 収集カウントの表示 | ユーザーが進捗を正しく把握できることを保証 | `1 / 2` 形式のテキストが表示されているか確認 |

### 1.2 インタラクションテスト

| テスト名 | WHY（目的） | HOW（検証方法） |
|---------|------------|----------------|
| スタイルボタンクリック | 個別スタイルのトグル機能が動作することを保証 | `fireEvent.click` 後、`onToggleStyle` が正しい引数で呼ばれたか確認 |
| 全選択/全解除ボタン | 一括操作機能が動作することを保証 | `fireEvent.click` 後、`onToggleAll(pokemon, true/false)` が呼ばれたか確認 |

### 1.3 フィルタ連携テスト

| テスト名 | WHY（目的） | HOW（検証方法） |
|---------|------------|----------------|
| フィールドフィルタ | 選択フィールドに出現しないスタイルが非表示になることを保証 | `excludeFromFields` を持つスタイルが `selectedField` 指定時に `queryByText` で見つからないことを確認 |

---

## 2. 複数カード一括操作テスト

### 2.1 概要

**バグ修正対象**: 全選択ボタンのダブルトグルおよび連続操作時の状態不整合

**テスト目的**: 複数のポケモンカードに対して全選択/全解除を実行した際、UIコールバックが正しく発火することを保証する。

### 2.2 テストケース詳細

| テスト名 | WHY（目的） | HOW（検証方法） |
|---------|------------|----------------|
| 3カードで全選択 | 複数カードそれぞれで `onToggleAll` が独立して呼ばれることを保証 | 3つの「全選択」ボタンを順にクリックし、各呼び出しで正しい `pokemon` と `true` が渡されたか `toHaveBeenNthCalledWith` で確認 |
| 3カードで全解除 | 複数カードそれぞれで `onToggleAll` が独立して呼ばれることを保証 | 3つの「全解除」ボタンを順にクリックし、各呼び出しで正しい `pokemon` と `false` が渡されたか確認 |
| 全選択→全解除連続 | 高速連続操作でコールバック順序が保たれることを保証 | 各カードで「全選択」→「全解除」を連続実行し、計6回のコールバックが正しい順序で呼ばれたか確認 |
| 収集カウント表示 | 複数カードでの部分収集状態が正しく反映されることを保証 | 異なる収集状態（1/2, 2/2, 0/3）を設定し、各カードで正しいカウント文字列が表示されるか確認 |

---

## 3. useCollection ロジックテスト

### 3.1 概要

このテストスイートは、`useCollection` フックの状態管理ロジックを**シミュレーション**することで検証します。実際のReactフックを呼び出すのではなく、内部ロジックを再現した関数 `simulateToggleAllPokemonStyles` を使用します。

```typescript
const simulateToggleAllPokemonStyles = (
  currentState: Set<string>,
  pokemon: Pokemon,
  select: boolean,
  selectedField: string = 'all'
): Set<string>
```

### 3.2 ダブルトグル検証

| テスト名 | WHY（目的） | HOW（検証方法） |
|---------|------------|----------------|
| 全選択2回連続 | ダブルクリックで状態が反転しないことを保証 | 同じポケモンに `select=true` を2回適用し、1回目と2回目の状態サイズが同じかつ全スタイル収集済みであることを確認 |
| 全解除2回連続 | ダブルクリックで状態が反転しないことを保証 | 全収集状態から `select=false` を2回適用し、両方とも `size === 0` であることを確認 |

**なぜこのテストが必要か:**

以前のバグでは、`collectedStyles.has(styleId)` をトグル判定に使用していたため、連続クリックで状態が反転していました。現在の実装では `select` 引数で意図を明示的に指定するため、この問題は発生しません。

### 3.3 連続操作検証

| テスト名 | WHY（目的） | HOW（検証方法） |
|---------|------------|----------------|
| 全選択→全解除 | 連続操作で最終状態が正しいことを保証 | `true` → `false` の順で適用し、最終的に `size === 0` であることを確認 |
| 全選択→全解除→全選択 | 複数回の切り替えで整合性が保たれることを保証 | `true` → `false` → `true` の順で適用し、最終的に全スタイル収集済みであることを確認 |

### 3.4 複数ポケモン一括操作検証

| テスト名 | WHY（目的） | HOW（検証方法） |
|---------|------------|----------------|
| 3ポケモン順次全選択 | 複数ポケモンへの一括操作が正しく累積することを保証 | 3ポケモンそれぞれに `select=true` を適用し、全スタイル（7件）が収集済みであることを確認 |
| 交互操作での独立性 | 1つのポケモンへの操作が他に影響しないことを保証 | P1全選択 → P2全選択 → P1全解除 → P3全選択 の順で実行し、P1のみ未収集、P2/P3は収集済みであることを確認 |
| 高速連続実行 | 各ポケモンで全選択→全解除を連続実行しても整合性が保たれることを保証 | 3ポケモンそれぞれで `true` → `false` を連続適用し、最終的に `size === 0` であることを確認 |

### 3.5 状態整合性検証

| テスト名 | WHY（目的） | HOW（検証方法） |
|---------|------------|----------------|
| functional update パターン | Reactの状態更新パターンでロジックが正しく動作することを保証 | `Array<(prev) => next>` 形式の更新関数を順次適用し、最終状態が期待通りであることを確認 |
| IDプレフィックスチェック | 類似ID（`poke-1` vs `poke-10`）で誤操作が発生しないことを保証 | `poke-1` を操作した際に `poke-10` のスタイルが影響を受けないことを確認 |

**なぜIDプレフィックスチェックが必要か:**

スタイルIDはポケモンID + サフィックスの形式（例: `poke-1-style`）を取ります。`id.startsWith(pokemon.id)` でフィルタリングする際、`poke-1` と `poke-10` が混同されないようにする必要があります。

---

## 4. テスト実行方法

### 4.1 全テスト実行

```bash
npm test
```

### 4.2 特定ファイルのみ実行

```bash
# PokemonCard テストのみ
npm test -- --testPathPattern="PokemonCard.test"

# useCollection テストのみ
npm test -- --testPathPattern="useCollection.test"
```

### 4.3 カバレッジ確認

```bash
npm test -- --coverage
```

---

## 5. 関連ファイル

| ファイル | 説明 |
|---------|------|
| `components/__tests__/PokemonCard.test.tsx` | UIコンポーネントテスト |
| `hooks/__tests__/useCollection.test.ts` | 状態管理ロジックテスト |
| `hooks/useCollection.ts` | テスト対象の実装 |
| `components/PokemonCard.tsx` | テスト対象のコンポーネント |
